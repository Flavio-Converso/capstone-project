@model capstone_project.Models.Game


@{
    ViewBag.Title = "Dettagli Gioco";
    var cartGameIds = ViewBag.CartGameIds as List<int> ?? new List<int>(); // List of games in the cart
}

<h2>Dettagli Gioco</h2>

<div>
    <h4>@Model.Name</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">Descrizione</dt>
        <dd class="col-sm-10">@Model.Description</dd>

        <dt class="col-sm-2">Piattaforma</dt>
        <dd class="col-sm-10">@Model.Platform</dd>

        <dt class="col-sm-2">Produttore</dt>
        <dd class="col-sm-10">@Model.Publisher</dd>

        <dt class="col-sm-2">Quantità disponibile</dt>
        <dd class="col-sm-10">@Model.QuantityAvail</dd>

        <dt class="col-sm-2">Prezzo</dt>
        <dd class="col-sm-10">@Model.Price.ToString("C")</dd>

        <dt class="col-sm-2">Data di Rilascio</dt>
        <dd class="col-sm-10">@Model.ReleaseDate.ToShortDateString()</dd>

        <dt class="col-sm-2">PEGI</dt>
        <dd class="col-sm-10">@Model.Pegi.Name</dd>

        <dt class="col-sm-2">Restrizioni</dt>
        <dd class="col-sm-10">
            @foreach (var restriction in Model.Restrictions)
            {
                <span>@restriction.Name</span>
            }
        </dd>

        <dt class="col-sm-2">Categorie</dt>
        <dd class="col-sm-10">
            @foreach (var category in Model.Categories)
            {
                <span>@category.Name</span>
            }
        </dd>

        <!-- Images Section -->
        <dt class="col-sm-2">Cover</dt>
        <dd class="col-sm-10">
            @{
                var coverImages = Model.GameImages.Where(img => img.ImgType == ImageType.Cover).ToList();
                if (coverImages.Any())
                {
                    foreach (var image in coverImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Cover Image" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No cover image available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Screenshot</dt>
        <dd class="col-sm-10">
            @{
                var screenshotImages = Model.GameImages.Where(img => img.ImgType == ImageType.Screenshot).ToList();
                if (screenshotImages.Any())
                {
                    foreach (var image in screenshotImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Screenshot" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No screenshots available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Artwork</dt>
        <dd class="col-sm-10">
            @{
                var artworkImages = Model.GameImages.Where(img => img.ImgType == ImageType.Artwork).ToList();
                if (artworkImages.Any())
                {
                    foreach (var image in artworkImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Artwork" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No artwork available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Icon</dt>
        <dd class="col-sm-10">
            @{
                var iconImages = Model.GameImages.Where(img => img.ImgType == ImageType.Icon).ToList();
                if (iconImages.Any())
                {
                    foreach (var image in iconImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Icon" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No icon available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Logo</dt>
        <dd class="col-sm-10">
            @{
                var logoImages = Model.GameImages.Where(img => img.ImgType == ImageType.Logo).ToList();
                if (logoImages.Any())
                {
                    foreach (var image in logoImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Logo" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No logo available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Banner</dt>
        <dd class="col-sm-10">
            @{
                var bannerImages = Model.GameImages.Where(img => img.ImgType == ImageType.Banner).ToList();
                if (bannerImages.Any())
                {
                    foreach (var image in bannerImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Banner" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No banner available</span>
                }
            }
        </dd>

        <dt class="col-sm-2">Other</dt>
        <dd class="col-sm-10">
            @{
                var otherImages = Model.GameImages.Where(img => img.ImgType == ImageType.Other).ToList();
                if (otherImages.Any())
                {
                    foreach (var image in otherImages)
                    {
                        var base64Image = Convert.ToBase64String(image.Img);
                        var imgSrc = $"data:image/png;base64,{base64Image}";
                        <img src="@imgSrc" alt="Other Image" style="width:100px;height:auto;" />
                    }
                }
                else
                {
                    <span>No other images available</span>
                }
            }
        </dd>
    </dl>
</div>

<a asp-action="List" class="btn btn-secondary">Indietro alla Lista</a>
<a asp-action="Edit" asp-route-id="@Model.GameId" class="btn btn-primary">Modifica</a>
<a asp-action="Delete" asp-route-id="@Model.GameId" class="btn btn-danger">Elimina</a>

@if (ViewBag.IsInWishlist)
{
    <form asp-controller="Wishlist" asp-action="RemoveFromWishlist" method="post" style="display:inline;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="gameId" value="@Model.GameId" />
        <input type="hidden" name="source" value="Details" />
        <button type="submit" class="btn btn-danger">Rimuovi dalla Wishlist</button>
    </form>
}
else
{
    <form asp-controller="Wishlist" asp-action="AddToWishlist" method="post" style="display:inline;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="gameId" value="@Model.GameId" />
        <input type="hidden" name="source" value="Details" />
        <button type="submit" class="btn btn-warning">Aggiungi alla Wishlist</button>
    </form>
}
@if (cartGameIds.Contains(Model.GameId) || Model.QuantityAvail == 0)
{
    <button class="btn btn-secondary" disabled>
        @(Model.QuantityAvail == 0 ? "Esaurito" : "Nel Carrello")
    </button>
}
else
{
    <form asp-controller="Cart" asp-action="AddToCart" method="post" style="display:inline;">
        @Html.AntiForgeryToken()
        <input type="hidden" name="gameId" value="@Model.GameId" />
        <input type="hidden" name="source" value="Details" />
        <button type="submit" class="btn btn-success">Aggiungi al carrello</button>
    </form>
}

<!-- Reviews section -->
<h3>Reviews</h3>
@if (Model.Reviews != null && Model.Reviews.Any())
{
    foreach (var review in Model.Reviews)
    {
        <div class="review" id="review-@review.ReviewId">
            <h5>@review.Title (@review.Rating/5)</h5>
            <p>@review.Content</p>
            <small>Posted by @review.User.Username on @review.Date.ToShortDateString()</small>

            <!-- Display the number of likes -->
            <p>
                <strong id="like-count-@review.ReviewId">@ViewBag.LikeCounts[review.ReviewId]</strong>
                <span id="plchld-@review.ReviewId"> likes</span>
            </p>

            <button class="btn btn-@(ViewBag.LikedReviews != null && ViewBag.LikedReviews.Contains(review.ReviewId) ? "danger" : "success") like-button"
                    data-review-id="@review.ReviewId"
                    data-liked="@((ViewBag.LikedReviews != null && ViewBag.LikedReviews.Contains(review.ReviewId)).ToString().ToLower())">
                @(ViewBag.LikedReviews != null && ViewBag.LikedReviews.Contains(review.ReviewId) ? "Unlike" : "Like")
            </button>
        </div>
        <hr />
    }
}
else
{
    <p>No reviews yet. Be the first to review this game!</p>
}


<!-- Partial View for Review Form -->
@if (ViewBag.HasReviewed)
{
    <p class="fw-bold text-success">You have already reviewed this game.</p>
}
else
{
    @await Html.PartialAsync("~/Views/Review/_ReviewForm.cshtml", new capstone_project.Models.ViewModels.ReviewViewModel
{
    GameId = Model.GameId
})
}
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).on('click', '.like-button', function (e) {
            e.preventDefault();

            var button = $(this);
            var reviewId = button.data('review-id');
            var liked = button.data('liked') === 'true';

            $.ajax({
                url: '@Url.Action("LikeReview", "Review")',
                type: 'POST',
                data: {
                    reviewId: reviewId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function (response) {
                    if (response.success) {
                        // Update like count
                        $('#like-count-' + reviewId).text(response.likeCount);

                        // Hide the placeholder text for this specific review
                        $('#plchld-' + reviewId).addClass('display-none');

                        // Toggle button text and color
                        if (response.liked) {
                            button.text('Unlike');
                            button.removeClass('btn-success').addClass('btn-danger');
                            button.data('liked', 'true');
                        } else {
                            button.text('Like');
                            button.removeClass('btn-danger').addClass('btn-success');
                            button.data('liked', 'false');
                        }
                    }
                },
                error: function () {
                    alert('An error occurred while processing your request. Please try again.');
                }
            });
        });
    </script>
}
